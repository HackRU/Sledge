# Deploy Script

Sledge includes a script to deploy with recommended settings on a Debian 9
system. The script can be found in `tools/deploy-debian9.sh`. The script is
useful if you are setting up a virtual machine solely for running sledge that
will be deprovisioned after your event.

If you're running on AWS a good hosting option is Amazon Lightsail, which
combines EC2 with networking and storage into a single instance, and provides
easy shell access from the browser with a Connect to SSH button. Of course,
dozens of other similar hosting services also exist.

## Script Usage

On the instance you would like to install Sledge you can simply run the
following commands.

```
$ wget https://raw.githubusercontent.com/HackRU/sledge/master/tools/deploy-debian9.sh
$ chmod +x deploy-debian9.sh
$ sudo ./deploy-debian9.sh
```

After running the deploy script, you will be asked to enter some options
described below.

 - `SLEDGE_SETUP_EMAIL`. This email is passed into certbot when requesting an
    SSL certificate. If certbot is successful this email will be passed to
    Let's Encrypt and used to warn you when the certificate is about to expire.
    If this doesn't interest you, you can leave it blank.
 - `SLEDGE_SETUP_DOMAIN`. This value is also passed into certbot when requesting
    an SSL certificate and also used when generating the nginx configuration and
    is the domain given to the self-signed certificate. Although certbot accepts
    a comma-separated list of domain, this variable should have exactly one.
 - `SLEDGE_SETUP_USERNAME` and `SLEDGE_SETUP_PASSWORD`. The script sets up  nginx
    basic http authentication over the socket.io endpoint, only allowing this
    username and password combination to access sledge. The user will be
    prompted to enter this username and password when they first visit a sledge
    page that accesses the socket endpoint.

Alternatively if you don't want to type these in they can be passed as
environment variables, or you can edit the file to assign them at the top.

At certain points during the setup the script will ask you to press enter to
continue. This can be disabled with `SLEDGE_SETUP_NOPAUSE=1`.

## Domain considerations

Before running the script you should have a domain you want to run sledge from.
An nginx site will be setup on the instance to serve sledge from **HTTPS ONLY**
and redirect to `https://$SLEDGE_SETUP_DOMAIN` any http requests.

If you don't have the domain setup before running the script the certbot request
will fail and a self-signed certificate will be used instead. You should still
be able to setup with the self-signed certificate (although your browser will
give you some warnings). If this happens then after you get the domain setup you
need to complete the following steps to get the certificate:

 1. Stop nginx with `sudo service nginx stop`
 2. Run `certbot --standalone` to get the certificate
 3. Create symlinks `/etc/nginx/ssl/sledge.cert` and `/etc/nginx/ssl/sledge.key`
    that point to the generated `privkey.pem` and `fullchain.pem` generated by
    certbot
 4. Replace `include snippets/ssl-nginx` with `include snippets/ssl-sledge` in
    the nginx configuration file `/etc/nginx/sites-available/sledge`
 5. Run `sudo nginx -t` to ensure the updated nginx configuration is correct
 6. Start nginx with `sudo service nginx start`

To prevent this you should ideally hold off on running the script until your DNS
is setup, but note that **it could take up to 48 hours for DNS to propegate**
meaning it might take 48 hours after setting DNS until Let's Encrypt is willing
to give you a certificate.
