# Deploy Script

Sledge includes a script to deploy with recommended settings on a Debian 9
system. The script can be found in `tools/deploy-debian9.sh`. The script is
useful if you are setting up a virtual machine solely for running sledge that
will be deprovisioned after your event.

There's a lot of hosting providers that provide servers where Sledge can run on,
but the simplest for AWS is Amazon Lightsail (see *Amazon Lightsail
Deployment* below).

## Script Usage

On the instance you would like to install Sledge you can simply run the
following commands.

```
$ wget https://raw.githubusercontent.com/HackRU/sledge/master/tools/deploy-debian9.sh
$ chmod +x deploy-debian9.sh
$ sudo ./deploy-debian9.sh
```

After running the deploy script, you will be asked to enter some options
described below.

 - `SLEDGE_SETUP_EMAIL`. This email is passed into certbot when requesting an
    SSL certificate. If certbot is successful this email will be passed to
    Let's Encrypt and used to warn you when the certificate is about to expire.
    If this doesn't interest you, you can leave it blank.
 - `SLEDGE_SETUP_DOMAIN`. This value is also passed into certbot when requesting
    an SSL certificate and also used when generating the nginx configuration and
    is the domain given to the self-signed certificate. Although certbot accepts
    a comma-separated list of domains, this variable should have exactly one (it
    cannot be blank).
 - `SLEDGE_SETUP_USERNAME` and `SLEDGE_SETUP_PASSWORD`. The script sets up nginx
    basic http authentication over the socket.io endpoint, only allowing this
    username and password combination to access sledge. The user will be
    prompted to enter this username and password when they first visit a sledge
    page that accesses the socket endpoint.

Alternatively if you don't want to type these in they can be passed as
environment variables, or you can edit the file to assign them at the top.

At certain points during the setup the script will ask you to press enter to
continue. This can be disabled with `SLEDGE_SETUP_NOPAUSE=1`.

## Domain considerations

Before running the script you should have a domain you want to run sledge from.
An nginx site will be setup on the instance to serve sledge from **HTTPS ONLY**
and redirect to `https://$SLEDGE_SETUP_DOMAIN` any http requests.

If you don't have the domain setup before running the script the certbot request
will fail and a self-signed certificate will be used instead. You should still
be able to setup with the self-signed certificate (although your browser will
give you some warnings). If this happens then after you get the domain setup you
need to complete the following steps to get the certificate:

 1. Stop nginx with `sudo service nginx stop`
 2. Run `certbot --standalone` to get the certificate
 3. Create symlinks `/etc/nginx/ssl/sledge.cert` and `/etc/nginx/ssl/sledge.key`
    that point to the generated `privkey.pem` and `fullchain.pem` generated by
    certbot
 4. Replace `include snippets/ssl-nginx` with `include snippets/ssl-sledge` in
    the nginx configuration file `/etc/nginx/sites-available/sledge`
 5. Run `sudo nginx -t` to ensure the updated nginx configuration is correct
 6. Start nginx with `sudo service nginx start`

To prevent this you should ideally hold off on running the script until your DNS
is setup, but note that **it could take up to 48 hours for DNS to propegate**
meaning it might take 48 hours after setting DNS until Let's Encrypt is willing
to give you a certificate.

## Amazon Lightsail Deployment

Amazon Lightsail combines compute, storage and networking into a single Virtual
Private Server (VPS), so it's probably the easiest way to deploy on AWS.

### Accessing Amazon Lightsail

Go to your AWS Management Console and under Find Services search for Lightsail.

### Creating a Static IP

A static IP can be created directly from Lightsail, in the Networking tab.
The IP won't immediately be attached to any instance, but this allows you to
setup DNS more easily.

### Creating an Instance
 
In Amazon Lightsail, click Create Instance. Since we plan to use the deploy
script the platform *must* be Linux/Unix and the blueprint *must* be Debian 9
(in my case this is Debian 9.5, but Debian is stable enough where the minor
version shouldn't matter).

Lightsail provides the option to use a launch script. Since you can't see
the output it's better run the launch script after the instance is provisioned.

In the past Sledge has had issues that could've been solved with choosing a
beefier instance (specifically with storage). Since instances are relatively
cheap, choose something with 60GB+ just to be safe.

### Setup Instance Networking

After opening the instance in Lightsail, go to the Netorking tab (this is
the instance-specific networking tab, and is different from the networking
tab where you created the static IP). Use the Attach Static IP button to
attach the static IP from before.

By default, Lightsail enables a strict firewall that will prevent Sledge from
running correctly. This can be disabled by adding a rule with Application set
to All Protocols. The iptables firewall within the instance is setup by the
script and will still be running.

### Running the Launch Script

The Connect tab should have a button providing an in-browser shell with admin
access into the VPS. From here you can run the script following the
instructions above.

### Re-launching the Instance

Since you're using a Static IP, you will not lose the IP address if you delete
the instance. If for some reason you need to re-create the instance or rerun
the deploy script, you can simply detach the Static IP in the networking tab
and attach it to a newly created instance. This way, re-deploying shouldn't
require any DNS changes.
